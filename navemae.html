<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <title>Comando Nave-M√£e</title>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; display: flex; gap: 20px; padding: 20px; }
        h2 { color: #bb86fc; border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        .painel { background: #1e1e1e; padding: 20px; border-radius: 10px; width: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* Tabela de Rovers */
        .rover-item { 
            display: flex; justify-content: space-between; align-items: center; 
            background: #2c2c2c; padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid #555;
        }
        .rover-info div { margin-bottom: 5px; }
        .st-IDLE { color: #00e676; font-weight: bold; }
        .st-EM_MISSAO { color: #2979ff; font-weight: bold; animation: pulse 1.5s infinite; }
        .st-CHARGING { color: #ffab00; font-weight: bold; }
        .st-OFFLINE { color: #ff5252; }

        button { cursor: pointer; padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; transition: 0.2s; }
        .btn-charge { background: #ffab00; color: #000; }
        .btn-charge:hover { background: #ffca28; }
        
        .btn-send { background: #bb86fc; color: #000; width: 100%; padding: 12px; font-size: 1.1em; margin-top: 15px; }
        .btn-send:hover { background: #d0aaff; }
        .btn-send:disabled { background: #555; color: #888; cursor: not-allowed; }

        input, select { width: 100%; padding: 10px; margin: 5px 0 15px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; }
        label { color: #aaa; font-size: 0.9em; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div class="painel">
        <h2>üì° Estado da Frota</h2>
        <div id="listaRovers">
            <div style="text-align:center; color:#777; margin-top:50px">A procurar sinal dos rovers...</div>
        </div>
    </div>

    <div class="painel">
        <h2>üó∫Ô∏è Atribuir Miss√£o</h2>
        
        <label>1. Selecionar Rover (Apenas IDLE):</label>
        <select id="selRover">
            <option value="">A aguardar dados...</option>
        </select>

        <label>2. Configurar Tarefa:</label>
        <input type="text" id="tarefa" value="Coleta de Amostras" placeholder="Ex: Fotografia, Sondagem...">

        <label>3. Dura√ß√£o (segundos):</label>
        <input type="number" id="duracao" value="15" min="5" max="120">

        <button id="btnEnviar" class="btn-send" onclick="enviarMissao()">üöÄ ENVIAR ORDEM</button>
        <div id="msgStatus" style="margin-top: 10px; text-align: center; color: #aaa;"></div>
    </div>

<script>
    const API_URL = "http://127.0.0.1:8080/api";
    let dadosCache = {};

    async function atualizarDashboard() {
        try {
            const res = await fetch(API_URL + '/global');
            const dados = await res.json();
            const frota = dados.frota || {};
            
            renderListaRovers(frota);
            atualizarDropdown(frota);
            
        } catch(e) { console.error("Erro API:", e); }
        
        setTimeout(atualizarDashboard, 1000); // Atualiza a cada 1s
    }

    function renderListaRovers(frota) {
        const container = document.getElementById('listaRovers');
        container.innerHTML = "";

        if(Object.keys(frota).length === 0) {
            container.innerHTML = "<div style='text-align:center; color:#777'>Nenhum rover detetado.</div>";
            return;
        }

        // Ordenar por ID
        Object.keys(frota).sort().forEach(key => {
            const r = frota[key];
            const id = r.id || key;
            const bat = r.bat || 0;
            const status = r.status || "OFFLINE";
            
            // Cor da borda baseada na bateria
            let borderCor = bat > 20 ? '#555' : '#ff5252';
            if (status === 'EM_MISSAO') borderCor = '#2979ff';

            const html = `
                <div class="rover-item" style="border-left-color: ${borderCor}">
                    <div class="rover-info">
                        <div style="font-size: 1.1em; font-weight: bold;">Rover-${id}</div>
                        <div>Status: <span class="st-${status}">${status}</span></div>
                        <div>Bateria: ${bat}%</div>
                    </div>
                    <button class="btn-charge" onclick="carregar(${id})">‚ö° CARREGAR</button>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    function atualizarDropdown(frota) {
        const sel = document.getElementById('selRover');
        const valorAtual = sel.value;
        sel.innerHTML = "";

        let algumDisponivel = false;

        Object.keys(frota).sort().forEach(key => {
            const r = frota[key];
            const status = r.status || "OFFLINE";
            
            let opt = document.createElement('option');
            opt.value = r.id || key;
            
            let texto = `Rover-${opt.value} (${status})`;
            if(status !== "IDLE") {
                opt.disabled = true;
                texto += " - Ocupado";
            } else {
                algumDisponivel = true;
            }
            
            opt.innerText = texto;
            sel.appendChild(opt);
        });

        if (valorAtual) sel.value = valorAtual;
        
        // Desativar bot√£o se n√£o houver rovers livres
        document.getElementById('btnEnviar').disabled = !algumDisponivel;
    }

    async function carregar(id) {
        if(!confirm(`Mandar carregar o Rover ${id}?`)) return;
        
        await fetch(API_URL + '/enviar_missao', {
            method: 'POST',
            body: JSON.stringify({ acao: "CHARGE", target_id: id })
        });
    }

    async function enviarMissao() {
        const id = document.getElementById('selRover').value;
        const tarefa = document.getElementById('tarefa').value;
        const dur = document.getElementById('duracao').value;

        if(!id) return alert("Selecione um rover v√°lido!");

        const statusDiv = document.getElementById('msgStatus');
        statusDiv.innerText = "A enviar...";

        try {
            const res = await fetch(API_URL + '/enviar_missao', {
                method: 'POST',
                body: JSON.stringify({
                    acao: "MISSAO",
                    target_id: id,
                    missao: { tarefa: tarefa, duracao: dur, id: "MANUAL-" + Date.now() }
                })
            });
            const json = await res.json();
            
            if(res.ok) statusDiv.innerText = "‚úÖ Miss√£o enviada!";
            else statusDiv.innerText = "‚ùå Erro: " + json.erro;
            
        } catch(e) {
            statusDiv.innerText = "‚ùå Erro de conex√£o.";
        }
    }

    // Iniciar
    atualizarDashboard();
</script>

</body>
</html>